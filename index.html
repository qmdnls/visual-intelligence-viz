<!doctype html>
<html>

<head>
  <title>Visual Intelligence Platform</title>

  <link rel="stylesheet" href="css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

  <style>
    body {
      font-size: 18px;
    } 

    .node rect {
      stroke: none;
      fill: none;
    }

    .env .card {
      background-color: #bfb6b6;
    }
    
    .qa .card {
      background-color: #6b5ced;
    }

    .dialog .card {
      background-color: #90f592;

    }
    
    .sigm .card {
      background-color: #f58e8e;
    }

    .module-name {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 18px;
      text-align: center;
    }

    .module-desc {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      text-align: left;
    }

    /* This sets the border color for nodes currently running. */ /*#e30707*/
    /*g.active>rect {
      stroke: #ff0000; 
      stroke-width: 5px;
    }*/
    .edgePath path {
      stroke: #333;
      stroke-width: 1.5px;
    }
  </style>

  <script src="js/d3.min.js"></script>
  <script src="js/dagre-d3.min.js"></script>
  <script src="js/dagre.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    $(function () {
      // Create svg canvas to draw the graph on
      $('#svg').append('<svg width=2000 height=2000></svg>');

      // Create a new directed graph
      var g = new dagre.graphlib.Graph();
      
      // Create the renderer
      var render = new dagreD3.render();

      // Set up an SVG group so that we can translate the final graph.
      var svg = d3.select("svg"),
        svgGroup = svg.append("g");

      var socket = io();
      socket.on('jsonUpdate', function (jsonData) {
        console.log(JSON.stringify(jsonData));
        /*$('#question_id').text("Question ID: " + jsonData.status.question_id);
        $('#question').text("Question: " + jsonData.status.question);
        $('#answers').empty();
        jsonData.status.answers.forEach(answer => $('#answers').append($('<li>').text(answer)));
        $('#correct_idx').text("Correct answer index: " + jsonData.status.correct_idx);
        $('#q_level_logic').text("Question logic level: " + jsonData.status.q_level_logic);
        $('#q_level_mem').text("Question memory level: " + jsonData.status.q_level_mem);
        $('#vid').text("Video: " + jsonData.status.vid);
        $('#shots').text("Shots contained: " + jsonData.status.shot_contained);*/

        // Overwrite the previous graph to redraw completely (we can't remove edges easily unfortunately) 
        g = new dagre.graphlib.Graph();

        // Set an object for the graph label
        g.setGraph({});

        // Default to assigning a new object as a label for each new edge.
        g.setDefaultEdgeLabel(function () { return {}; });

        // Set left-to-right orientation
        g.graph().rankDir = 'LR';

        modules = jsonData;
        modules.forEach(generateNode);

        // Run the renderer. This is what draws the final graph.
        render(d3.select("svg g"), g);

        g.nodes().forEach(function(v) {
            console.log("Node " + v + ": " + JSON.stringify(g.node(v)));
        });
        g.edges().forEach(function(e) {
            console.log("Edge " + e.v + " -> " + e.w + ": " + JSON.stringify(g.edge(e)));
        });

        // Center the graph
        svg.attr("width", g.graph().width + 80);
        svg.attr("height", g.graph().height + 80);
        var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
        svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
      });

      function generateNode(module, index) { 
        var nodeLabel = `<div class="card text-white" style="width: 200px;"><h5 class="card-header text-wrap module-name">${module.name}</h5><div class="card-body module-desc"><p class="card-text">Some text</p></div>` 
        g.setNode(`${module.id}`, { labelType: 'html', label: nodeLabel, padding: 0, class: `${module.state} ${module.group}` })
        module.next_module.forEach(next => g.setEdge(`${module.id}`, next.toString(), { curve: d3.curveBasis }))
      }


    });
  </script>
</head>

<body>
  <div id="svg"></div>
</body>

</html>
