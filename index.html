<!doctype html>
<html>

<head>
  <title>Visual Intelligence Platform</title>

  <style>
    body {
      font-size: 18px;
    } 

    g.dialog>rect {
      fill: #90f592;
    }

    g.qa>rect {
      fill: #6b5ced;
    }
    
    g.sigm>rect {
      fill: #f58e8e;
    }
    
    text {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
    }

    .node rect {
      stroke: #999;
      fill: #fff;
      stroke-width: 1.5px;
    }

    /* This sets the border color for nodes currently running. */
    g.active>rect {
      stroke: #ff0000; /*#e30707*/
      stroke-width: 5px;
    }
    .edgePath path {
      stroke: #333;
      stroke-width: 1.5px;
    }
  </style>

  <script src="js/d3.min.js"></script>
  <script src="js/dagre-d3.min.js"></script>
  <script src="js/dagre.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    $(function () {
      // Create svg canvas to draw the graph on
      $('#svg').append('<svg width=2000 height=2000></svg>');

      // Create a new directed graph
      var g = new dagre.graphlib.Graph();
      
      // Create the renderer
      var render = new dagreD3.render();

      // Set up an SVG group so that we can translate the final graph.
      var svg = d3.select("svg"),
        svgGroup = svg.append("g");

      var socket = io();
      socket.on('jsonUpdate', function (jsonData) {
        console.log(JSON.stringify(jsonData));
        /*$('#question_id').text("Question ID: " + jsonData.status.question_id);
        $('#question').text("Question: " + jsonData.status.question);
        $('#answers').empty();
        jsonData.status.answers.forEach(answer => $('#answers').append($('<li>').text(answer)));
        $('#correct_idx').text("Correct answer index: " + jsonData.status.correct_idx);
        $('#q_level_logic').text("Question logic level: " + jsonData.status.q_level_logic);
        $('#q_level_mem').text("Question memory level: " + jsonData.status.q_level_mem);
        $('#vid').text("Video: " + jsonData.status.vid);
        $('#shots').text("Shots contained: " + jsonData.status.shot_contained);*/

        // Overwrite the previous graph to redraw completely (we can't remove edges easily unfortunately) 
        g = new dagre.graphlib.Graph();

        // Set an object for the graph label
        g.setGraph({});

        // Default to assigning a new object as a label for each new edge.
        g.setDefaultEdgeLabel(function () { return {}; });

        // Set left-to-right orientation
        g.graph().rankDir = 'LR';

        modules = jsonData;
        modules.forEach(generateNode);

        // Run the renderer. This is what draws the final graph.
        render(d3.select("svg g"), g);

        g.nodes().forEach(function(v) {
            console.log("Node " + v + ": " + JSON.stringify(g.node(v)));
        });
        g.edges().forEach(function(e) {
            console.log("Edge " + e.v + " -> " + e.w + ": " + JSON.stringify(g.edge(e)));
        });

        // Center the graph
        svg.attr("width", g.graph().width + 80);
        svg.attr("height", g.graph().height + 80);
        var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
        svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
      });

      function generateNode(module, index) {
          g.setNode(`${module.id}`, { label: `${module.name}`, width: 130, height: 70, class: `${module.state} ${module.group}` })
        module.next_module.forEach(next => g.setEdge(`${module.id}`, next.toString()))
      }


    });
  </script>
</head>

<body>
  <div id="svg"></div>
</body>

</html>
